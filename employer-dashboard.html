<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Employer Dashboard</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #f4f6f9; }
        .navbar { background: #007bff; color: white; }
        .company-logo { width:56px; height:56px; border-radius:8px; object-fit:cover; }
        .company-avatar { width:56px; height:56px; border-radius:8px; display:flex;align-items:center;justify-content:center;background:#e9ecef;color:#333;font-weight:700;font-size:22px }
        .sidebar { min-height:100vh; background:white; border-right:1px solid #e9ecef; }
        .main { padding:24px; }
        .card { box-shadow:0 2px 8px rgba(0,0,0,0.08); }
        .job-item { border-left:4px solid #007bff; margin-bottom:12px; }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <div class="d-flex align-items-center">
            <div id="companyAvatar" class="company-avatar mr-3" aria-hidden="true"></div>
            <img id="companyLogoImg" class="company-logo mr-3" src="https://via.placeholder.com/56" alt="logo" style="display:none">
            <span class="navbar-brand">Employer Dashboard</span>
        </div>
        <div class="ml-auto text-white">
            <span id="employerName">Company</span>
            <button id="logoutBtn" class="btn btn-light btn-sm ml-3">Logout</button>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-3 sidebar p-4">
            <h5>Profile</h5>
            <div class="mb-3 text-center">
                <input type="file" id="logoInput" accept="image/*" style="display:none">
                <button class="btn btn-outline-primary btn-sm" id="changeLogo">Change Logo</button>
                <p class="mt-2 text-muted small">Upload company logo</p>
            </div>
            <hr>
            <nav class="nav flex-column">
                <a class="nav-link active" href="#" data-section="post">Post Internship</a>
                <a class="nav-link" href="#" data-section="list">My Postings</a>
                <a class="nav-link" href="#" data-section="apps">Applications</a>
                <a class="nav-link text-danger" href="#" id="deleteAccount">Delete Account</a>
            </nav>
        </div>

        <div class="col-md-9 main">
            <section id="post-section">
                <div class="card p-4">
                    <h4>Post New Internship</h4>
                    <form id="postForm">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label>Title</label>
                                <input id="jobTitle" class="form-control" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label>Location</label>
                                <input id="jobLocation" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Duration</label>
                                <input id="jobDuration" class="form-control" placeholder="e.g., 3 months">
                            </div>
                            <div class="form-group col-md-4">
                                <label>Stipend</label>
                                <input id="jobStipend" class="form-control" placeholder="e.g., $500/month">
                            </div>
                            <div class="form-group col-md-4">
                                <label>Deadline</label>
                                <input id="jobDeadline" type="date" class="form-control">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="jobDesc" class="form-control" rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary" type="submit">Post Internship</button>
                    </form>
                </div>
            </section>

            <section id="list-section" style="display:none">
                <div class="card p-4">
                    <h4>My Postings</h4>
                    <div id="myJobsList" class="mt-3"></div>
                </div>
            </section>

            <section id="apps-section" style="display:none">
                <div class="card p-4">
                    <h4>Applications</h4>
                    <div id="applicationsPanel" class="mt-3"></div>
                </div>
            </section>
        </div>
    </div>
</div>

<script>
    // Require employer role
    const username = localStorage.getItem('username');
    const role = localStorage.getItem('userRole');
    if (!username || role !== 'employer') {
        alert('Access denied — please login as employer.');
        window.location.href = 'login form.html';
    }

    document.getElementById('employerName').textContent = username;

    // Avatar/logo handling: show saved logo image if present, otherwise show initial from business name
    function setCompanyAvatar() {
        const avatarEl = document.getElementById('companyAvatar');
        const logoImg = document.getElementById('companyLogoImg');
        const companyLogoData = JSON.parse(localStorage.getItem('employerLogo_' + username) || 'null');
        if (companyLogoData && companyLogoData.fileData) {
            logoImg.src = companyLogoData.fileData;
            logoImg.style.display = 'block';
            avatarEl.style.display = 'none';
            return;
        }

        // derive business name from saved form or verification record, fallback to username
        let business = '';
        try {
            const saved = JSON.parse(localStorage.getItem('employerFormData_' + username) || localStorage.getItem('employerVerification_' + username) || '{}');
            business = saved.businessName || saved.business || '';
        } catch (e) { business = ''; }
        if (!business) business = username || '';
        const first = (business.trim().split(/\s+/)[0] || '').charAt(0).toUpperCase() || '?';
        avatarEl.textContent = first;
        avatarEl.style.display = 'flex';
        logoImg.style.display = 'none';
    }

    setCompanyAvatar();

    document.getElementById('changeLogo').addEventListener('click', () => document.getElementById('logoInput').click());
    document.getElementById('logoInput').addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
            const data = { fileName: f.name, fileData: reader.result };
            localStorage.setItem('employerLogo_' + username, JSON.stringify(data));
            setCompanyAvatar();
            alert('Logo updated');
        };
        reader.readAsDataURL(f);
    });

    // Navigation
    document.querySelectorAll('.sidebar .nav-link, .nav-link').forEach(link => {}); // no-op to keep styles
    document.querySelectorAll('.nav.flex-column .nav-link').forEach(link => {
        link.addEventListener('click', function(e){ e.preventDefault();
            document.querySelectorAll('#post-section, #list-section, #apps-section').forEach(s=>s.style.display='none');
            const section = this.getAttribute('data-section');
            if (section === 'post') document.getElementById('post-section').style.display='block';
            if (section === 'list') { document.getElementById('list-section').style.display='block'; loadMyJobs(); }
            if (section === 'apps') { document.getElementById('apps-section').style.display='block'; loadApplicationsForEmployer(); }
            document.querySelectorAll('.nav.flex-column .nav-link').forEach(n=>n.classList.remove('active')); this.classList.add('active');
        });
    });

    // Post job
    document.getElementById('postForm').addEventListener('submit', function(e){
        e.preventDefault();
        const job = {
            id: Date.now(),
            title: document.getElementById('jobTitle').value,
            company: username,
            location: document.getElementById('jobLocation').value,
            duration: document.getElementById('jobDuration').value,
            stipend: document.getElementById('jobStipend').value,
            description: document.getElementById('jobDesc').value,
            deadline: document.getElementById('jobDeadline').value
        };
        // save to global internships
        const global = JSON.parse(localStorage.getItem('globalInternships') || '[]');
        global.unshift(job);
        localStorage.setItem('globalInternships', JSON.stringify(global));
        // save to my jobs
        const mine = JSON.parse(localStorage.getItem('employerJobs_' + username) || '[]');
        mine.unshift(job);
        localStorage.setItem('employerJobs_' + username, JSON.stringify(mine));
        alert('Job posted successfully');
        this.reset();
    });

    function loadMyJobs() {
        const panel = document.getElementById('myJobsList');
        const mine = JSON.parse(localStorage.getItem('employerJobs_' + username) || '[]');
        if (!mine.length) { panel.innerHTML = '<p class="text-muted">No postings yet.</p>'; return; }
        panel.innerHTML = mine.map(j=>`
            <div class="job-item p-3">
                <h5>${j.title}</h5>
                <p class="text-muted">${j.company} · ${j.location} · ${j.duration} · ${j.stipend}</p>
                <p>${j.description}</p>
                <div class="d-flex justify-content-end">
                    <button class="btn btn-sm btn-outline-primary mr-2" onclick="viewApplicants(${j.id})">View Applicants</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="editJob(${j.id})">Edit</button>
                </div>
            </div>
        `).join('');
    }

    function viewApplicants(jobId) {
        // show apps section and filter
        document.getElementById('apps-section').style.display='block';
        document.getElementById('list-section').style.display='none';
        document.querySelectorAll('.nav.flex-column .nav-link').forEach(n=>n.classList.remove('active'));
        document.querySelector('[data-section="apps"]').classList.add('active');
        loadApplicationsForEmployer(jobId);
    }

    function loadApplicationsForEmployer(jobId) {
        const panel = document.getElementById('applicationsPanel');
        const apps = JSON.parse(localStorage.getItem('applications') || '[]');
        // If jobId passed, filter to that job, else show all for this employer's postings
        const myJobs = JSON.parse(localStorage.getItem('employerJobs_' + username) || '[]');
        const myJobIds = myJobs.map(j=>j.id);
        const filtered = apps.filter(a => (jobId ? a.internshipId === jobId : myJobIds.includes(a.internshipId)));
        if (!filtered.length) { panel.innerHTML = '<p class="text-muted">No applications yet.</p>'; return; }

        panel.innerHTML = filtered.map(a=>`
            <div class="p-3 mb-2" style="background:white;border-radius:6px;">
                <div class="d-flex justify-content-between">
                    <div>
                        <strong>${a.applicantUsername || 'Applicant'}</strong>
                        <div class="text-muted small">Applied for: ${a.internshipTitle} · ${a.applicationDate}</div>
                    </div>
                                    <div class="text-right">
                                    <div class="mb-2"><span class="badge badge-pill badge-secondary">${a.status}</span></div>
                                    <button class="btn btn-sm btn-success" onclick="acceptApplication(${a.id})">Accept</button>
                                    <button class="btn btn-sm btn-danger" onclick="rejectApplication(${a.id})">Reject</button>
                                    <button class="btn btn-sm btn-warning" onclick="reportApplicant(${a.id})">Report</button>
                                </div>
                </div>
                <div class="mt-2">
                    <small>Resume: ${a.resumeFileName || 'Not provided'}</small>
                </div>
            </div>
        `).join('');
    }

    function acceptApplication(appId) {
        if (!confirm('Confirm accept applicant?')) return;
        let apps = JSON.parse(localStorage.getItem('applications') || '[]');
        const app = apps.find(a => a.id === appId);
        if (!app) return;
        app.status = 'accepted';
        app.decisionMessage = 'Congratulations! We are pleased to offer you the internship.';
        localStorage.setItem('applications', JSON.stringify(apps));

        // notify applicant by storing a notification
        try {
            const notifKey = 'notifications_' + (app.applicantUsername || '');
            const notifications = JSON.parse(localStorage.getItem(notifKey) || '[]');
            notifications.unshift({ id: Date.now(), type: 'accepted', message: app.decisionMessage, date: new Date().toLocaleString(), internshipTitle: app.internshipTitle });
            localStorage.setItem(notifKey, JSON.stringify(notifications));
        } catch (e) {
            console.error('Failed to store notification', e);
        }

        loadApplicationsForEmployer();
        alert('Applicant accepted and notified.');
    }

    function rejectApplication(appId) {
        const reason = prompt('Enter a polite rejection reason (optional):', 'Thank you for applying. We have chosen another candidate.');
        if (reason === null) return; // cancelled
        let apps = JSON.parse(localStorage.getItem('applications') || '[]');
        const app = apps.find(a => a.id === appId);
        if (!app) return;
        app.status = 'rejected';
        app.decisionMessage = reason;
        localStorage.setItem('applications', JSON.stringify(apps));

        // notify applicant
        try {
            const notifKey = 'notifications_' + (app.applicantUsername || '');
            const notifications = JSON.parse(localStorage.getItem(notifKey) || '[]');
            notifications.unshift({ id: Date.now(), type: 'rejected', message: reason, date: new Date().toLocaleString(), internshipTitle: app.internshipTitle });
            localStorage.setItem(notifKey, JSON.stringify(notifications));
        } catch (e) {
            console.error('Failed to store notification', e);
        }

        loadApplicationsForEmployer();
        alert('Applicant rejected. Reason sent.');
    }

    function reportApplicant(appId) {
        const reason = prompt('Report applicant for suspected scam or policy violation. Provide details:');
        if (reason === null || reason.trim() === '') return;
        const apps = JSON.parse(localStorage.getItem('applications') || '[]');
        const app = apps.find(a => a.id === appId);
        if (!app) return alert('Application not found.');

        // create security alert for review
        const alertsKey = 'securityAlerts';
        const alerts = JSON.parse(localStorage.getItem(alertsKey) || '[]');
        const alertObj = {
            id: Date.now(),
            type: 'reported_scammer',
            reporter: username,
            username: app.applicantUsername || '',
            jobId: app.internshipId,
            internshipTitle: app.internshipTitle,
            date: new Date().toLocaleString(),
            message: reason
        };
        alerts.unshift(alertObj);
        localStorage.setItem(alertsKey, JSON.stringify(alerts));

        alert('Report submitted. The report will be reviewed by our team.');
        // Optionally refresh employer view
        loadApplicationsForEmployer();
    }

    // Delete account (local demo)
    document.getElementById('deleteAccount').addEventListener('click', ()=>{
        if (!confirm('Delete account and all local data?')) return;
        localStorage.removeItem('userRole');
        localStorage.removeItem('username');
        localStorage.removeItem('employerJobs_' + username);
        window.location.href = 'login form.html';
    });

    document.getElementById('logoutBtn').addEventListener('click', ()=>{
        localStorage.removeItem('userRole'); localStorage.removeItem('username'); window.location.href = 'login form.html';
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>