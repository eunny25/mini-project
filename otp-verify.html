<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OTP Verification</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background:#f4f6f8; }
        .otp-box { max-width:420px;margin:60px auto;background:white;padding:24px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);} 
        .code-input { font-size:1.6rem;letter-spacing:6px;text-align:center; }
    </style>
</head>
<body>
<div class="otp-box">
    <h4 class="mb-3">Two-factor Authentication</h4>
    <p id="otpMessage" class="text-muted">We sent a 6-digit code to your email.</p>

    <div class="form-group">
        <input id="otpInput" class="form-control code-input" maxlength="6" placeholder="Enter OTP" autofocus>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <div><button id="verifyBtn" class="btn btn-primary">Verify</button></div>
        <div class="text-right">
            <div class="small text-muted">Expires in <span id="timer">--:--</span></div>
            <button id="resendBtn" class="btn btn-link btn-sm">Resend</button>
        </div>
    </div>

    <div id="status" class="text-danger small"></div>
    <div class="mt-3">
        <button id="cancelBtn" class="btn btn-outline-secondary btn-sm">Cancel</button>
    </div>
</div>

<script>
    const pendingUser = localStorage.getItem('pendingOTPUser');
    const pendingRole = localStorage.getItem('pendingOTPRole');
    if (!pendingUser) {
        alert('No pending verification found. Redirecting to login.');
        window.location.href = 'login form.html';
    }

    const otpKey = 'otp_' + pendingUser;
    let otpObj = JSON.parse(localStorage.getItem(otpKey) || 'null');

    const timerEl = document.getElementById('timer');
    const otpInput = document.getElementById('otpInput');
    const statusEl = document.getElementById('status');

    function formatTime(ms) {
        if (ms <= 0) return '00:00';
        const s = Math.floor(ms/1000);
        const mm = Math.floor(s/60).toString().padStart(2,'0');
        const ss = (s%60).toString().padStart(2,'0');
        return mm + ':' + ss;
    }

    function refreshOTPObj() { otpObj = JSON.parse(localStorage.getItem(otpKey) || 'null'); }

    function updateTimer() {
        refreshOTPObj();
        if (!otpObj) { timerEl.textContent = '00:00'; document.getElementById('resendBtn').disabled = false; return; }
        const remaining = otpObj.expiresAt - Date.now();
        timerEl.textContent = formatTime(remaining);
        if (remaining <= 0) {
            statusEl.textContent = 'OTP expired. Please resend.';
            document.getElementById('resendBtn').disabled = false;
            clearInterval(timerInterval);
        }
    }

    let timerInterval = setInterval(updateTimer, 500);
    updateTimer();

    document.getElementById('verifyBtn').addEventListener('click', function() {
        const entered = (otpInput.value || '').trim();
        refreshOTPObj();
        if (!otpObj) { statusEl.textContent = 'No OTP found or it expired.'; return; }
        if (Date.now() > otpObj.expiresAt) { statusEl.textContent = 'OTP expired. Please resend.'; return; }
        if (entered === otpObj.code) {
            // success
            // finalize login: set username & role, clear pending and otp
            localStorage.setItem('username', pendingUser);
            localStorage.setItem('userRole', pendingRole);
            localStorage.removeItem('pendingOTPUser');
            localStorage.removeItem('pendingOTPRole');
            localStorage.removeItem(otpKey);
            alert('Verification successful. Redirecting...');

            // route based on role and verification status for employers
            if (pendingRole === 'admin') {
                window.location.href = 'admin-dashboard.html';
            } else if (pendingRole === 'applicant') {
                window.location.href = 'applicant-dashboard.html';
            } else if (pendingRole === 'employer') {
                const ver = JSON.parse(localStorage.getItem('employerVerification_' + pendingUser) || 'null');
                if (ver && ver.status === 'approved') {
                    window.location.href = 'employer-dashboard.html';
                } else {
                    window.location.href = 'employer-verification.html';
                }
            } else {
                window.location.href = 'login form.html';
            }
        } else {
            // wrong OTP
            otpObj.attempts = (otpObj.attempts || 0) + 1;
            localStorage.setItem(otpKey, JSON.stringify(otpObj));
            statusEl.textContent = 'Invalid OTP. Attempts: ' + otpObj.attempts;

            // log security alert on repeated failures
            if (otpObj.attempts >= 3) {
                const alerts = JSON.parse(localStorage.getItem('securityAlerts') || '[]');
                alerts.unshift({ id: Date.now(), type: 'otp_failed', username: pendingUser, date: new Date().toLocaleString(), message: 'Multiple failed OTP attempts.' });
                localStorage.setItem('securityAlerts', JSON.stringify(alerts));
            }
        }
    });

    document.getElementById('resendBtn').addEventListener('click', function() {
        // resend generates new OTP and resets expiry
        const code = Math.floor(100000 + Math.random() * 900000);
        const obj = { id: Date.now(), code: String(code), expiresAt: Date.now() + 5*60*1000, attempts: 0, resendCount: (otpObj && otpObj.resendCount ? otpObj.resendCount + 1 : 1) };
        localStorage.setItem(otpKey, JSON.stringify(obj));
        otpObj = obj;
        statusEl.textContent = 'New OTP sent.';
        alert('New OTP (demo): ' + code);
        clearInterval(timerInterval);
        timerInterval = setInterval(updateTimer, 500);
        updateTimer();
    });

    document.getElementById('cancelBtn').addEventListener('click', function() {
        if (confirm('Cancel verification and return to login?')) {
            localStorage.removeItem('pendingOTPUser');
            localStorage.removeItem('pendingOTPRole');
            window.location.href = 'login form.html';
        }
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
